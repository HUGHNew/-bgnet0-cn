# 域名系统（DNS）

我们已经了解到IP协议负责在互联网上路由流量。还学到它可以对IP地址进行处理，通常我们以点和数字格式展示IPv4地址，例如`10.1.2.3`。不过作为人类用户，我们很少使用IP地址，当你使用网页浏览器时，基本上你不会将一个IP地址直接输入到地址栏。

即使在我们的项目中，我们都倾向于输入`localhost`，而不是直接输入`127.0.0.1`来表示本地地址。在计算机网络中，一般将我们使用的`www.example.com`等名称转换为计算机使用的IP地址的过程称之为 _域名解析_ ，它由称之为 _域名系统_(DNS)的分布式服务器组来完成。

## 常见用法

从用户的角度来看，我们为设备配置一个“名称服务器”，这些设备可以通过和它连接，将名称转换为IP地址。(这可能是用DHCP配置的，稍后会详细介绍。)当你尝试去连接`example.com`时，你的计算机会首先连接名称服务器来询问IP地址。

如果该名称服务器知道上述问题的答案是什么的时候，它将直接提供结果，如果它不知道，那么一系列齿轮就要开始转动了。让我们深入了解下整个过程。

## 域名和IP地址

如果你从未注册过一个域名（比如说 `example.com`或者`oregonstate.edu`或者`google.com`或者`army.mil`），那么整个过程会很像是:
1. 联系 _域名注册商_ (比如，一些拥有售卖全部域名权利的公司)。
2. 选择一个还没有人使用的域名。
3. 每年向他们付费来使用这些域名。
4. ...
5. 从中盈利！

但是这样做与IP地址的概念就完全脱节了，事实上，没有IP地址的域名也可以存在——它们只是不能被使用。一旦你有了你的域名，你可以联系一个托管公司，他们会为你提供一个供你使用的服务器上的IP地址。

现在你有两样东西了:域名和IP地址。不过，你仍然需要将它们关联起来，这样用户才能通过你的域名地址查询到你的IP地址。为此，你需要将包含相关信息的数据库记录添加到一个叫做DNS地方:_域名服务器_。

## （域名）名称服务器

通常我们简称它为 _name servers_, 这些服务器包含它们有 _权限_ 的所在域的IP记录。也就是说，没有一个域名服务器含有全世界的记录，每个服务器只服务一个特定的域或子域。

> _子域_ 是一个由域拥有者创建的域。举例来说，`example.com`的拥有者可以创建子域
> `sub1.example.com`和`sub2.example.com`。在这些例子中，这些都不是真实的主机,
> 但是它们都可以被分配给真实的机器，举例来说，`host1.sub1.examople.com`, 
> `host2.sub1.example.com`,`somecompy.sub2.example.com`。
>
>
> 域所有者可以根据需要创建任意多的子域。他们只需要确保有一个域名服务器来处理它们即可。

一个被授权的名称服务器可以被特定域中任何主机查询。主机号通常是域名的第一个“部分”，但是其实它不是必须的。

举例来说，`www.example.com`，这是一个位于域`example.com`的名叫`www`的主机。一个单独的命名服务器需要被很多域授权。

但是，即使名称服务器不知道它被要求提供的域名的IP地址，它也可以向其他名称服务器进行查询。从用户的角度来看，这个过程是无感的。

所以,非常简单。如果不知道被查询的域名，我只要去联系属于那个域的名称服务器以获得答案。

## 根域名服务器

然而，我们有个问题，如果我都不知道域名的名称服务器是什么，我如何连接到域名服务器?

为了解决这个问题，互联网上有一系列被称为 _根域名服务器_ 一路上指引我们。当我们不知道IP地址的时候，我们可以从它们这里开始，它们要么直接告诉我们IP地址，要么告诉我们应该继续询问哪个服务器。稍后会详细介绍这个过程。

在互联网上，预先配置了13个计算机作为根域名服务器的IP地址。这些ip很少改变，并且只需要其中一个就可以工作。负责DNS的计算机经常检索该列表以保持最新的信息。

根域名服务器为自己依次取名`a` 到 `m`:

``` {.default}
a.root-servers.net
b.root-servers.net
c.root-servers.net
...
k.root-servers.net
l.root-servers.net
m.root-servers.net
```

## 过程示例

让我们从查询一台域名为`www.example.com`的计算机开始。我们需要知道它的IP地址，但是我们不知道哪个域名服务器负责`example.com`域名，但是我们知道根域名服务器的列表。

1. 首先计算机会随机选择一个根服务器，比如说`c.root-servers.net`，我们将会联系这个服务器并且说，“你好，我们正在寻找`www.example.com`，你能帮帮我们吗？”但是，根域名服务器并不知道这个问题的答案，所以它说，“我不知道答案，但是我可以告诉你，你想查询任何关于`.com`域名的信息，你可以去询问下面这些域名服务器中的任何一个。”随后，它会给出一个知道`.com` 域名的服务器列表:

2. 此时，我们只要选择其中一个管理`.com`域名的服务器，然后和它说：“你好，`h.gtld-servers.net`，我们正在寻找 `www.example.com`。你能给予帮助么？“随后，它回答：”我不认识这个名字，不过我知道`example.com`的域名服务器，你可以询问下面任何一个”。同样，它返回了一系例知道`example.com`域的域名服务器名单：

3. 和上面过程一样，我们随意选择名单中的一个服务器，对它说：“你好，`a.iana-servers.net`，我们正在寻找`www.example.com`。你能提供帮助么？”，然后该域名服务器回答：“是的，我可以！我熟悉这个名字！它的IP地址是`93.184.216.34`!"

所以对于任意查询，计算机都会从根服务器开始，随后它会指引计算机去发现更多的信息。（除非信息已经被缓存到某个地方，但稍后会详细介绍。）

## 区

在互联网中，域名系统被划分为多个逻辑管理单位，称之为 _区_。区是在特定域名服务器权限下的域的集合。不过上面的叙述过于简化了，同一区中可以有一个或多个域，而且可能有很多域名服务器在同一区工作。

可以将这些区看做是一种对于所有它负责的域名以及子域名的管理单位的集合。举例来说，对于根区，我们可以看到一系列它负责查找的域名服务器，同样对于`.com`区，也有一系列它授权管理的域名服务器。

## 解析库

当你在你编写的代码中使用域名时，它将会调用一个库来做DNS查询。可能你已经注意到了在Python中的如下代码：

``` {.py}
s.connect(("example.com", 80))
```

此时，你无需担心任何有关DNS的信息，在这个调用的背后，Python会自动帮你从DNS中查询到相应域名的信息。在C语言中，有一个叫`getaddrinfo()`承担者同样的功能。

简单来说就是，在各种语言中，都有一个库来完成此项功能，而作为程序编写者自己，无需做任何改动。

而操作系统还有一条记录，其中包含用于查找的默认名称服务器。(大部分时候是手工配置，但更常见的是通过[DHCP](https://en.wikipedia.org/wiki/Dynamic主机配置协议)进行配置。)因此，当你查找请求时，你的计算机首先会转向这个服务器。

不过等一下--上述的过程如何能与根服务器层次结构对应起来呢?答案是:缓存系统！

## 缓存服务器

想象一下在全局范围内发生的所有DNS查找操作，如果每个请求都必须访问根服务器，这不仅会花费很长时间来处理重复的请求，而且根服务器也会受到严重的影响。为了避免这种情况，所有的DNS解析库以及DNS服务器都会 _缓存_ 它们的结果。

> 作为一个最上层的服务器，根服务器每天要处理上万亿的请求。
> As it is, the root servers handle literally trillions of requests per
> day.

通过这种方式，我们可以避免重复请求使根服务器而导致过载。

所以，我们得修改一下已经学习过的知识点。

1. 首先计算机向我们的解析器库查询IP地址。如果它已经缓存了，则直接返回。

2. 如果缓存中没有条目，去域名服务器查找对应的IP地址，如果域名服务器中有缓存，则直接返回对应的IP地址。

3. 如果在域名服务器内仍然没有缓存 **并且** 该域名服务器有上层的域名服务器，它会向更上层的域名服务器寻找答案。

4. 如果更上层的域名服务器依然没有缓存的结果，并且也没有更上层的域名服务器了，该域名服务器会向根服务器发起查询请求并进行之前我们阐述的过程。

如果每次都能命中缓存，那么这对于分担根域名服务器的压力大有帮助。很多你家里的WiFi路由器也会缓存域名服务器信息。所以当DHCP开始配置你的计算机时，你的计算机会使用路由器作为局域网内计算机的DNS服务器。这将为DNS查找提供快速响应，因为你的计算机到路由器的ping时间非常短。

### 存活时间

由于域名或主机的IP地址可能会改变，我们必须有一种方法来使缓存条目过期。

这是通过DNS里面的一个被称之为 _存活时间（TTL）_ 的字段来实现的。 这是服务器应该保持缓存的秒数，通常它被设置为86400秒（1天），不过这个数字都可以根据区管理员认为IP地址多久应该变化的结果而改变。当一个缓存条目过期时，如果有人请求，名称服务器将不得不再次请求来自上游或根服务器的数据。

## 记录类型

到目前为止，我们已经讨论了使用DNS将主机或域名映射到相应的IP地址，这些是DNS服务器上的域存储记录类型之一。

一些常见的记录类型有:
* `A`:IPv4地址记录。这就是我们一直在阐述的类型。用来回答问题“此主机或域的IPv4地址是什么?”

* `AAAA`:IPv6地址记录。用来回答问题“此主机或域的IPv6地址是什么?”

* `NS`: 特定域的域名服务器记录。用来回答问题，“这个主机或域的名称服务器该回答什么?”

* `MX`: 邮件交换记录。用来回答问题“哪些计算机负责处理这个域中的邮件?”

* `TXT`: 文本记录。保存自由格式的文本信息。有时用于反垃圾邮件目的和证明域的所有权。

* `CNAME`: 规范名称记录。把它当作一个别名。用来生成声明，“域名xyz.example.com是abc.example.com的别名。”

* `SOA`: 权限开始记录。这包含有关域的信息，包括其主域名服务器和联系信息。

除此之外，还有[很多DNS记录类型](https://en.wikipedia.org/wiki/List_of_DNS_record_types).

## 动态DNS

通常一般Internet的用户家中设备是没有静态IP地址(即专用的或不变的)的。如果他们重启调制解调器，他们的ISP可能会给他们一个不同的IP地址。而这将引起DNS的骚动，因为这种行为会导致指向其公共ip的任何DNS记录都将过期。

动态DNS（DDNS）立志于解决这个问题。简而言之，有两种机制:
1. 一种是客户机告诉DDNS服务器其IP地址.

2. 一种是DDNS服务器会对那条记录设置一个非常小的TTL。

虽然DNS定义了一种发送更新记录的方式，但另一种常见的方式是让局域网上的计算机定期(例如每10分钟)通过采取身份验证的HTTP请求来联系DDNS提供商。当DDNS服务器将看到发送来的IP地址，使用它来更新记录。

## 反向DNS

如果你有一个点和数字的IP地址，但是需要查找的是该IP的主机名，这时该怎么办?你可以进行 _反向DNS_ 查找。请注意，并非所有IP地址都有这样的记录，并且反向DNS查询通常会出现空结果。

## 思考题

* 现在你电脑的域名服务器是什么?你可以在网上搜索如何根据你的操作系统查找到该信息。

* 根域名服务器是不是可以知道世界上的每一个IP地址？

* 动态DNS的作用是什么？

* TTL的作用是什么？