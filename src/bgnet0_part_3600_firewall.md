# 防火墙

每一部糟糕的黑客电影中最受欢迎的一个部分就是 _防火墙_ 。从那些糟糕的电影中可以清楚地了解到，它与安全有关，但确切的作用确是模糊的，很明显，一个坏人成功的通过防火墙是一件坏事。

但是让我们回到现实中来: 防火墙是一台计算机(通常是路由器)，它的主要目的是限制一个接口和另一个接口之间的某些特定类型的流量。因此，相较于普通路由器从每个端口转发各种类型的每个数据包，它可能会决定丢弃一些数据包。这样做的结果是，如果有人试图连接到防火墙远端的端口，防火墙可能会阻止该连接，但这个最终取决于防火墙的配置方式。

在本章中，我们主要是从概念上介绍防火墙，而不是详细讨论实际配置。防火墙有很多种实现方式，它们都倾向于使用不同的配置方法。

## 防火墙操作

如果你站在一个到达路由器的数据包角度来思考，路由器有能力检查它想要的所有数据包。它可以查看源ip和目标ip，或者端口，甚至是应用层数据。

这样它才有机会决定是否继续转发基于任何数据的数据包。

例如，可以将防火墙配置为允许任何端口80 (HTTP)流量从防火墙外部进入防火墙内部，但阻止所有其他目的端口上的传入的流量。或者它还可以被配置为只允许某些IP地址连接。

因此，当防火墙在收到数据包时，会首先查看其配置的规则，再决定是否丢弃数据包(如果它位于被过滤掉的规则中)，抑或是正常转发该数据包。

当它决定丢弃数据包时，有很多选择供其实现，它可以只是静默地丢弃它，也可以用[ICMP](https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol)发送“目的地不可达”的应答消息。

这个基本的过滤机制提供了一些控制，但仍然有一些你可能想做但是它无法管理的事情。

例如，如果防火墙后面的某个人通过因特网从一个随机端口建立了一个TCP连接，而我们希望能够从该随机端口将流量返回到发送主机。如果只使用纯过滤，我们只能是允许所有这些端口上的所有流量。

但是通过 _状态过滤_ ，防火墙可以跟踪从防火墙后面发起的TCP连接的状态。防火墙看到TCP三次握手，就知道存在一个有效的连接。然后，它可以安全地允许流量返回到内部计算机的随机端口号。

有状态过滤也可以用于UDP流量，即使它是无连接的。对于这种流量，防火墙看到UDP数据包发出，它将允许传入的UDP数据包到该端口。(这里会先允许数据通过一段时间，由于它是无连接的，因此无法判断服务器和客户端何时结束,所以防火墙在设置超时UDP规则后会自动终止流量通过。)

> 为了防止防火墙在任何规则上超时，程序可以发送一种被称之为 _keepalive_ 的消息。TCP
> 实际上为此有一个特定的消息类型，操作系统将定期发送空的`ACK`报文，以防止任何人超时。
> (如果你使用套接字编程，一般来说，你需要设置 `SO_KEEPALIVE`选项。)
>
> keepalive也可以通过使用UDP的程序实现。可以将它配置为每隔一段时间向接收方(接收方将
> 以某种ACK进行回复)发送一个自定义的keepalive包。
>
> Keepalive只会在长时间没有网络流量的程序中会出现问题。


最后，过滤也可以在应用层完成。例如，如果防火墙对数据包进行足够深入的挖掘，它可能会发现它是HTTP或FTP数据。有了这些知识，它可以允许或拒绝所有HTTP流量，即使它到达的是一个非标准端口。

## 防火墙和NAT

在家庭网络中，防火墙同时充当路由器和交换机并进行NAT转换的功能是很常见的，在这里，这些都是一体的。

但是没有什么能阻止我们在网络上拥有一台单独的计算机做防火墙，它的作用仅仅是判断流量是否允许通过。并且也并没有规定防火墙的一边必须是私有网络，另一边必须是公网。双方都可以是私有网络或公网，或者一个私有和一个公网。

防火墙的核心作用并不是分隔公网和私有网络——这是NAT的作用——而是控制哪些流量可以通过防火墙。

## 本地防火墙

你也可以直接在你的计算机上设置防火墙(而通常这是一个常见的行为)。通常设置所有的连接都可以从本地计算机发出，但限制从其他计算机进入的连接。

在MacOS和Windows中，防火墙可以简单地打开，并且它会根据一些常见规则阻止流量。如果你需要某些特定的端口不被阻塞，则必须手动添加这些端口。

Linux通过一种叫做[iptables](https://en.wikipedia.org/wiki/Iptables)的机制支持防火墙。它不是最直接的配置方案，但它确实足够强大，可以从头构建NAT路由器/防火墙。

## 思考题

* 防火墙和路由器的不同点和联系是什么？

* 防火墙和NAT的不同点和联系是什么？

* [海军罪案调查处](https://www.youtube.com/watch?v=u8qgehH3kEQ?)中最有趣或最痛苦的事情是什么?

