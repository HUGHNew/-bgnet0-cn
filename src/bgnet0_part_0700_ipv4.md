# 因特网协议版本4（IPv4）

这是第一个被广泛使用的因特网协议版本，并且至今也在被广泛使用着。

## IP 地址

一个IPv4地址用“点和数字”表示，比如:

``` {.default}
198.51.100.125
```

IPv4地址永远是四个数字，每个数字用一个字节表示，所以每个数字可以表示的范围是0到255（二进制`00000000` 到 `11111111`）。这也表示每个IPv4地址都是4个字节（32位）。

## 子网

整个IP地址都含有 _子网_，IP地址的第一部分表示的就是我们正在讨论的子网编号，剩下的表示该子网中计算机的编号，而由多少位来构成“IP的第一部分”是可变的。当你设置公开的IP地址时，你将需要给向你付费的来获得链接的任何人划分并提供子网地址，你能提供的子网地址越多，你需要付出的费用也越多。

所以，当你说:"我需要180个静态IP地址。"时，你的网络提供商可能会想，好的，这意味着你需要180个IP地址和2个保留的IP地址（全0和分配地址中最大数字），一共182个地址。根据这个数字，我需要用8位来表示数字0-255，这是能提供182个IP地址需要的最小的位数。基于此，它们会提供给你一个子网，其中用24位网络位和8位主机位。

这个可以用如下的方式表示:

``` {.default}
你的子网位于198.51.100.0，其中前24位表示网络位，后8位表示主机位。
```

不过，这些都太繁琐了，所以一般情况下，我们使用斜杠来更简洁的表示:
``` {.default}
198.51.100.0/24
```

这种表示法告诉我们IP地址中的24位表示网络编号。（所以`32-24=8`位表示主机编号。）不过这到底代表什么呢？让我们把这个描述简单的用图表示下:
``` {.default}
24 位网络码
----------
198.51.100.0
           -
         8 位主机码
```

或者将这些数字全部转换为二进制:
``` {.default}
       24 位网络码         | 8 位主机码
-------------------------------+---------
11000110 . 00110011 . 01100100 . 00000000
     198         51        100          0
```

上述的所有位于我们伪造的子网中的IP都以`198.51.100.x`开头，最后一位就是我们正讨论的主机号。下面是我们这个子网中的一些合理的主机号:

``` {.default}
198.51.100.2
198.51.100.3
198.51.100.4
198.51.100.30
198.51.100.212
```

不过有两个地址具有特殊的意义（请看下表）:
``` {.default}
198.51.100.0     保留
198.51.100.255   广播地址 (详情请看下面)
```

除了这两个IP地址之外，我们可以使用其它任何合法的ip地址。现在，我特意选择了一个表示子网的字节在合法范围边界的例子，因为这样更容易看出整个最后一个字节是否还是合法主机号。但实际上，我们对于这没有任何限制，我们可以轻易的举出一个例子。

``` {.default}
198.51.100.96/28
```

在这个例子中：
``` {.default}
           28 位网络位          | 4 位主机位
-------------------------------------+----
11000110 . 00110011 . 01100100 . 0110 0000
     198         51        100          96
```

我们只能用最后4位不同的数字标示该子网中的主机，其中`0000`和`1111`分别是保留地址和广播地址，这样在此划分中，我们拥有14个可用的主机编号。

比如，我们可以以主机号2（二进制`0010`）来填充最后[4位](https://en.wikipedia.org/wiki/Nibble):
``` {.default}
           28 位网络位          | 4 位主机位
-------------------------------------+----
11000110 . 00110011 . 01100100 . 0110 0000
     198         51        100          96
```

这样，我们的得到的IP地址是 `198.51.100.98`。所有在`198.51.100.96`到`198.51.100.111`之间的IP地址都是该子网中合法的IP地址(虽然该范围内的第一个地址是保留地址，最后一个地址是广播地址)。

最后，如果你拥有一个自己的子网网段，你完全可以将其继续划分为更小的子网——只需要使用更多的位数来作为网络划分位。ISPs（因特网服务提供商，就像有线电视或者电话公司）就是一直在做这件事情。它们被赋予了一个大的子网网段，比如说，12位的网络位（这样就有20位的主机位，可以容纳将近100万的主机），然后一些客户想要从它们这里获取到子网段，ISP根据需求，决定将接下来的9位（打个比方）作为更小的子网网段，将其售卖给这些客户，这样每个客户可以自由使用剩下的11位作为自己的主机位（最大可以支持2048个主机）。

``` {.default}
  ISP 网络      |   子网段    |    主机段
   (12 bits)   |  (9 bits)  |  (11 bits)
---------------+------------+--------------
11010110 . 1100 0101 . 11011 001 . 00101101   [example IP]
```

但是,该划分的过程远远不止只到这里，也许在这些你给他售卖了11位子网的客户想要更细的去划分它——他们可以增加更多的网络位来继续定义自己的子网。当然，每次增加更多网络位，将会获得更少的可分配的主机位，当然，这也是你根据实际情况需要做出的妥协。

## 子网掩码

另一种表示子网的方法是使用 _子网掩码_，它是一个数字，当与任何IP地址按位进行和运算时，你会得到你的子网号。那么这到底是什么意思，为什么会这样呢？

子网掩码也是用点-数形式来进行表示的，并且看起来很像一个将子网位全部置`1`的IP地址。举个例子，如果我们有一个子网段`198.51.100.0/24`，这意味着我们的子网段是这样的:

``` {.default}
       24 网络位                | 8 主机位
-------------------------------+---------
11000110 . 00110011 . 01100100 . 00000000
     198         51        100          0
```

将所有网络位置`1`，我们可以得到如此一个模式:
``` {.default}
       24 网络位                | 8 主机位
-------------------------------+---------
11111111 . 11111111 . 11111111 . 00000000
     255        255        255          0
```
所以，`198.51.100.0/24`的子网掩码是`255.255.255.0`，这时 _所有_ `/24`的子网掩码。以此类推，将所有`/16`子网段前16位置1，可以得到对应的子网掩码`255.255.0.0`。

为什么会发明出这样的表示方法？因为路由器可以快速的通过简单的和运算来判断出一个指定IP地址的子网地址。所以子网掩码是`255.255.255.0`的IP地址`198.51.100.67`，其子网段是`198.51.100.0`。
``` {.default}
         24 网络位                | 8 主机位
  -------------------------------+---------
  11000110 . 00110011 . 01100100 . 01000011    198. 51.100.67
& 11111111 . 11111111 . 11111111 . 00000000  & 255.255.255. 0
-------------------------------------------  ----------------
  11000110 . 00110011 . 01100100 . 00000000    198. 51.100. 0
```

## 已被淘汰的规定子网段

_(此信息仅供历史参考。)_

在为网络保留任意数量的位数之前，子网被划分为3个主要类别:
* **A类** - 子网掩码 `255.0.0.0` (或者说 `/8`), 支持 16,777,214 个主机
* **B类** - 子网掩码 `255.255.0.0` (或者说 `/16`), 支持 65,534 个主机
* **C类** - 子网掩码 `255.255.255.0` (或者说 `/24`) 支持 254 个主机

这种划分定义会导致了子网分布的不均匀，一些大公司有1600万台主机(虽然他们并不需要这么多)，但是没有子网类可以支持合理数量的计算机，比如1000台。所以，这才是为什么后面切换至更加灵活的“任意的子网位”尝试。

## 特殊的地址

有一些非常值得关注的特殊地址:
* **127.0.0.1** - 这个地址代表你正在操作的计算机，通常，它会被映射到主机名`localhost`。
* **0.0.0.0** - 保留地址，任何一个子网上主机号为0的地址都是保留地址。
* **255.255.255.255** - 广播地址，用来表示一段子网中的所有主机，虽然看起来这将广播到整个互联网，但是路由器不会真的转发数据包到这个地址。你可以通过将所有位置为1来将消息广播到本地子网段，比如，子网段`198.51.100.0/24`的广播地址是`198.51.100.255`。

## 特殊子网

你还可能会遇到一些有特殊意义的子网段:
* **10.0.0.0/8** - 私有网段 (_非常常见_)
* **127.0.0.0/8** - 通过 _环回_ 设备的本地计算机
* **172.16.0.0/12** - 私有网段
* **192.0.0.0/24** - 私有网段
* **192.0.2.0/24** - 供说明使用，可[参见](https://www.rfc-editor.org/rfc/rfc5737)
* **192.168.0.0/16** - 私有网段 (_非常常见_)
* **198.18.0.0/15** - 私有网段
* **198.51.100.0/24** - 供说明使用，可[参见](https://www.rfc-editor.org/rfc/rfc5737)
* **203.0.113.0/24** - 供说明使用，可[参见](https://www.rfc-editor.org/rfc/rfc5737)
* **233.252.0.0/24** - 供说明使用，可[参见](https://www.rfc-editor.org/rfc/rfc5737)

在你家的网络设备中，通常你会发现你的IP地址位于上述的一个“私有”地址范围，大概率是`192.168.x.x`。你可以使用上述供说明使用的网段来作为文档中使用示例IP地址（非真实IP）。

## 思考题
* 为什么`192.168.262.12` 是一个非法的网络地址?

* 思考下子网概念作为划分全局地址空间的方式的一些优点。

* 当前你的电脑的IPv4地址是什么，子网掩码又是什么？（可能你需要学习下在你的操作系统中如何查看这俩信息）

* 如果你看到10.37.129.212/17，这其中有多少位是主机位？
