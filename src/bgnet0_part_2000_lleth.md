# 链接层和以太网

我们将深入到互联网的核心:链路层。

<!-- 图示: 因特网分层模型 -->
|层级|职责|协议举例|
|:-:|-|-|
|应用层|结构化的应用层数据|HTTP, FTP, TFTP, Telnet, SSH, SMTP, POP, IMAP|
|传输层|数据完整性，数据分割和组装|TCP, UDP|
|网络层|路由|IP, IPv6, ICMP|
|链路层|物理设备，线路上的电信号|Ethernet, PPP, token ring|

链路层是将网络的比特转换为电信号的一层。正如我们马上将要看到的，这是以太网存在的层级。

## 八位位组一览

之前我们一直使用“字节”表示8位二进制数字，现在是时候更加规范一些了。从历史上看，一个字节不一定是8位二进制。(众所周知，C编程语言并没有明确规定一个字节到底有多少位。)没有什么能阻止电脑设计者去创造东西。只不过巧合的是，基本上每台现代计算机都用8位来表示一个字节。

为了更精确，人们有时用 _八位位组_ 这个词来表示8位二进制。它的表示严格的8位二进制。当一个人平时说出（或者写下）“字节”，他们大概率还是指的是8位二进制序列。当一个人说“八位位组”时，那么它表示的是严格的8位二进制，不含任何其他的意思。

## 帧与包

当我们讲到链路层时，我们需要习惯更多的术语。通过以太网发送的数据是一个数据包，但在数据包中是一个 _帧_。它就像一个包的更下一层概念。在会话中，人们交替使用以太网的“帧”和“包”。但是，正如我们后面将要看到的，在完整的ISO OSI分层网络模型中这俩存在着区别。在简化的因特网分层网络模型中，这个两个概念并没有进行区分，而这导致了术语混淆。

本章稍后将详细介绍这个迷人的细节。

## MAC 地址

每个网络接口设备都有一个MAC(媒体访问控制)地址。这是LAN(局域网)上唯一的地址，用于发送和接收数据。

以太网MAC地址是由6个十六进制字节(12个十六进制数字)组成，中间用冒号(或连字符或句号)分隔。例如，这些都是你可能看到的MAC地址的表示方式:

``` {.default}
ac:d1:b8:df:20:85
ac-d1-b8-df-20-85
acd1.b8df.2085
```

MAC地址在局域网内必须不能重复。这些数字是由制造商出厂时就分配好的，通常最终用户不会修改。(只有当你碰巧不走运，买了两个恰好分配了相同MAC地址的网卡时，你才会想要改变它们。)

以太网MAC地址的前三个字节称为 _OUI_ (组织唯一标识符)，它被分配给各个制造商。这使得每个制造商有三个字节来唯一地表示他们制造的网卡。(这是16,777,216种可能的唯一组合。如果制造商用完了，他们总是可以获得另一个OUI——市面上也有1600万个OUI !)

> 有趣的互联网流言: 曾经有一家制造商生产一种叫做NE2000的仿冒网卡，该网卡本身已被称为
> “便宜货”网卡。仿冒品制造商采取的捷径是在他们生产的每张卡上刻录相同的MAC地址。而当一
> 家公司购买了大量的电脑，却发现一次只有一台电脑可以工作时，事情就败露了。当然，在一个
> 家庭局域网中，一般只会有一张这样的网卡，这就不会造成问题--这就是这个制造商赚钱的漏洞。
> 雪上加霜的是，仿冒卡上的MAC地址是无法更改的。所以那家买了网卡的公司只能强制性的报废
> 这些网卡。
>
> 不过,可以留下一台。

## 我们达成了一致（通常情况下）

你将直接接触到的许多现代链路层协议都是基于这样的想法运行的，即它们都将都广播到共享媒介中，同时侦听对于它们的流量。这就像在一个人声鼎沸的房间里，有人喊你的名字——你得到了给你的数据，其他人都会忽略它。

在现实生活中的同样的方法也以太网等协议。当你在以太网网络上传输数据包时，同一以太网局域网上的其他人都可以看到该流量。除非该流量是专门发给他们的，不然他们的网卡会忽略不属于自己的流量。

> 注释：在这一段中有一些功能非常简单的设备。
>
> 一个是在现代的有线以太网中，一个被称为 _交换机_ 设备，它通常会阻止防止数据包发送到
> 不应该被发送的节点。因此，网络并不像之前使用的拥挤的房间这种类比所暗示的那样嘈杂。在
> 交换机出现之前，我们使用的设备被称为 `集线器`, 它并不具有区分不同目的地的能力。它们
> 会将所有的以太网数据包广播到所有的地址中。

然而，并非每个链路层协议都以这种方式工作。但是所有链轮层协议的共同目标是在线路级别发送和接收数据。

## 多路访问方法

准备好听更多的背景故事了吗?如果同一个以太网上的每个人都在同一个房间里对其他人大喊大叫，那么在网线上是如何运作的呢?多个实体如何以不冲突的方式访问到共享的媒介?

> 当我们说“媒介”的时候，我们指的是网线(当你把电脑插入到网络中)，或者电波（当你使用WiFi时）。
> When we're talking "medium" here, we mean wires (if you've plugged
> your computer into the network) or radio (if you're on WiFi).

链路层协议用来允许多个实体访问共享媒介的方法称为 _多址访问方法_ ，或 _通道访问方法_ 。

而这有[很多方法可以做到这一点](https://en.wikipedia.org/wiki/Channel_access_method),在同一个媒介上:

* 你可以在不同的频率上发送数据包。
* 你可以在不同的时间片上发送数据包，就像分时复用。
* 你可以使用扩频或跳频。
* 你可以把网络分成不同的“小组”。
* 你可以再加一条线，让流量同时在两个方向流动。

让我们再次以以太网作为一个例子，以太网使用的是面所提的类似“分时复用”模式。但如何去实现，保留了众多的选择。

有线以太网使用一种叫做[CSMA/CD](https://en.wikipedia.org/wiki/Carrier-sense_multiple_access_with_collision_detection)(带碰撞检测的载波感知多路访问)的东西。说出名词比理解起来简单多了。

该方法以以下的模式工作:
1. 以太网卡在房间里安静得待命——当没有其他网卡正在传输时。(这是CSMA/CD的“CSMA”部分。)

2. 以太网卡开始发送数据。

3. 在发送数据的同时，它也在监听网络。

4. 如果它收到了发出去的同一份，一切正常。
   如果它没有收到它发送的相同的东西，这意味着另一个网络设备也在同一时间开始传输。这是一个碰撞检测，CSMA/CD的“CD”部分。

5. 为了解决这个问题，网卡会发送一个叫做“拥塞信号”的特殊信号来提醒其他网卡，网络上已经发生数据包碰撞，此时应该停止传输。然后网卡等待一个短而随机的时间，然后返回步骤1进行重试传输。

WiFi（无线）网络使用一些相似的技术，除了它叫[CSMA/CA](https://en.wikipedia.org/wiki/Carrier-sense_multiple_access_with_collision_avoidance)（具有碰撞避免的载波感知多址接入）。同样，说出名词比理解起来简单多了。

该方法以以下的模式工作:
1. 以太网卡在房间里安静得待命——当没有其他网卡正在传输时。(这是CSMA/CA的“CSMA”部分。)

2. 如果信道中开始有信号，那么网卡等待一个短而随机的时间，随后重新回到步骤1进行尝试。

这里省略了一些细节，但这些细节就是要点，在后面会详细说明。

## 以太网

还记得在分层网络模型中，每一层是如何将前一层的数据 _封装_ 到自己的报头中的吗?

例如，HTTP数据(应用层)被封装在TCP(传输层)报头中。然后所有这些都被包裹在IP(网络层)报头中。接着**所有**这些又都被一起封装在以太网(链路层)帧中。并且，每一层的协议都拥有它自己的报头结构来完成自己这部分的工作。以太网这一层没有任何的区别，它也会封装它之上的层级的数据。

现在，我想对这些术语进行一些仔细阐述。传输的整个数据块是以太网 _数据包_。但在它里面是以太网 _帧_。正如我们稍后将看到的，这些对应于ISO OSI分层网络模型的两层(在因特网分层网络模型中已被浓缩为单个“链路层”)。

虽然我在这里写了数据包“内部”的帧，但请注意它们都是作为单个比特流传输的。

* **数据包:**
  * 7 个八元组: 前缀（十六进制 : `AA AA AA AA AA AA AA`）
  * 1 个八元组: 帧分割符开始（十六进制: `AB`）
  * **数据帧**
    * 6个八元组: 目的地MAC地址
    * 6个八元组: 源MAC地址
    * 4个八元组: 为区分[虚拟局域网](https://en.wikipedia.org/wiki/VLAN)而设立的["Dot1q" 标签](https://en.wikipedia.org/wiki/IEEE_802.1Q)
    * 2个八元组: 负载长度/以太网类型
    * 46-1500个八元组: 负载
    * 4个八元组: [CRC-32 校验和](https://en.wikipedia.org/wiki/Cyclic_redundancy_check#CRC-32_algorithm)
  * 数据帧结束标示，载波信号丢失
  * 包间的间隙，对应于传输12八个元组所需的时间。

负载长度/[以太网类型](https://en.wikipedia.org/wiki/EtherType)字段通常是被用来表示要发送的负载的真实长度，但是也可以填充一些其他的值来表示另一种有效载荷结构。可以传输的最大有效载荷是1500个八元组。这就是网络的最大传输单元MTU (Maximum Transmission Unit)。更大的数据必须被分割到这个大小。

> 以太网硬件可以使用这个1500的数字来区分到底这个报头字段是负载长度还是以太网类型。
> 如果数字小于等1500，那么它就是一个长度，不然，它就是一个以太网类型。
> Ethernet hardware can use this 1500 number to differentiate the
> Payload Length/EtherType header field. If it's 1500 octets or fewer,
> it's a length. Otherwise it's an EtherType value.

在帧之后，有一个帧结束标记。这可以通过网线上载波信号的丢失来表示，或者通过某些版本的以太网中的某些显式传输标示来表示。最后，以太网数据包之间有一个时间间隔，对应于传输12八元组所需的时间。

### 因特网的两层？

如果你还记得的话，我们的简化层模型实际上是完整的ISO OSI 7层模型的压缩版本:

<!-- 图示: ISO OSI网络模型-->
|ISO OSI 层级|职责|示例协议|
|:-:|-|-|
|应用层|结构化的应用化数据|HTTP, FTP, TFTP, Telnet, SMTP, POP, IMAP|
|表示层|编码传输，加密，压缩|MIME, SSL/TLS, XDR|
|会话层|挂起，终止，重启两台计算机之前的会话|Sockets, TCP|
|传输层|数据完整性，数据分割和组装|TCP, UDP|
|网络层|路由|IP IPv6, ICMP|
|数据链路层|将数据装入帧中|Ethernet, PPP, SLIP|
|物理层|物理器件，线路上的信号|Ethernet physical layer, DSL, ISDN|

当我们谈及因特网模型的”链路层“时，其实是这里的”数据链路层“ _和_ "物理层“的结合。因特网的数据链路层就是传输 _数据帧_ 的层级， 它是（上面提到的）物理层中整个 _数据包_ 的一个子集。

思考这个问题的另一种方式是，数据链路层主要需要解决处理逻辑实体，比如谁拥有什么MAC地址，有效负载校验和是什么。而物理层的全部任务就是弄清楚要发送的信号模式所对应的数据包和帧的开始和结束，何时降低载波信号，以及传输之间的延迟时间。

## 思考题

* 你电脑的MAC地址是什么？可以尝试在互联网上搜索下如何将它找出来。

* 以太网中 _帧_ 与 _包_ 的区别是什么?它们在ISO OSI网络栈中的什么位置?

* 字节和八元组之间的区别是什么？

* CSMA/CD和CSMA/CA之间的主要区别是什么？

