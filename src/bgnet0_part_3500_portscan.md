# 端口扫描

**合法性的说明**: 对一台不属于自己的电脑进行端口扫描是否是合法行为是未知的，所以我们将在`localhost`上进行所有的端口扫描。**未经许可，请勿对计算机进行端口扫描!**

端口扫描是一种确定计算机上哪些端口已准备好接受连接的方法。换句话说，可以知道哪些端口有服务程序在监听。端口扫描通常是攻击系统的先锋方法，在尝试通过连接服务器来查看是否有任何漏洞之前，我们需要通过端口扫描知道服务器上有哪些正在运行的程序。

## 端口扫描的机制

一个端口扫描程序会尝试去寻找指定IP上的正在监听的端口范围。（有时候，该范围是全部的端口号。）

对于TCP，端口扫描程序通常会尝试在候选端口上使用`connect()` 调用来建立连接，如果该方法成功，那么我们将会得到一个开放的端口，此时端口扫描程序可以输出该信息。由于没有任何东西通过连接发送，该端口会立即关闭。

> 端口扫描程序的作用是扫描寻找开放的端口，而不是发送或者接收其他数据。

调用`connect()`会促使TCP连接完成三次握手，这并不是一定需要的，因为端口扫描器程序只要能从服务器得到任何回复(即三次握手的第二步)，那么我们就知道该端口是打开的。如果完成握手将导致远程操作系统唤醒该端口上的服务器，接着会进行我们知道无论如何都要发生的连接的关闭。

一些TCP端口扫描器程序将构建一个TCP SYN包来启动握手并将其发送到对端端口，如果它们得到一个SYN-ACK应答，它们就知道端口是打开的。但是，接下来，它们不是用一个ACK完成握手，而是发送一个RST(重置)，导致远程操作系统完全终止新创建的连接——并使得它不会唤醒该端口上的服务器程序。

> 你可以使用[原始套接字](https://en.wikipedia.org/wiki/Network_socket#Types)
> 来编写定制化的TCP数据包。通常你需要管理员权限来使用它们。

### UDP上的端口扫描

由于没有与UDP的连接，所以基于UDP的端口扫描一般不太精确。

有一种方法是向一个端口发送一个UDP数据包，看看是否收到一个[ICMP](https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol)“目的地不可达”消息。如果是，则对应的端口未打开。

如果你没有收到回复，_有可能_ 是端口没有打开，也有可能是UDP包被过滤掉了，没有ICMP响应。

另一种方法是将UDP数据包发送到可能有服务器程序的已知端口。如果从服务器得到响应，就知道端口是打开的。如果没有，它是关闭的，或者你的流量被过滤掉了。

## 思考题

* 为什么你不能对着因特网上任一计算机进行端口扫描？
  
* 端口扫描程序的目的是什么？
  