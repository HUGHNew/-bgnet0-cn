# 网络地址转换（NAT）

在本节中，我们将学习 _网络地址转换_，或者称之为NAT。这是一种在路由器上提供的服务，它将“私有”的局域网地址和世界其他地方隐藏起来。

这里路由器充当中间人，将内部IP地址转换为单个外部IP地址。而在这个服务中保存了这些连接的映射表，因此当数据包到达任何一个接口时，路由器可以适当地重写它们。

我们说NAT路由器后面的局域网是一个“私有网络”，而路由器为该局域网提供的外部IP地址是“公共IP”。

## 传统邮局类比

想象下，一个匿名的信件系统是如何工作的。你写一封信寄给收信人，上面写着你的回信地址。

你把信交给匿名者，而不是直接寄出去。匿名者将你的信从信封中取出，并将其放入另一个信封中，该信封的收信人相同，但将寄信人的地址替换为匿名者的地址。它还记录了这个寄件人给这个收件人写了一封信。

当收件人收到信时，它所看到的全是信上面的匿名人的地址。然后，收件人回复信件，并将回复寄回给匿名人士，同时收件人将自己列为回信地址。

匿名者收到邮件并注明是收件人发来的。接着，它在其记录中查找，以确定最初向收件人寄出信件的人。匿名者将回复从信封中取出，并将其放入新信封中，目的地址为原始发件人，返回地址保留为原始收件人。

最后，原始的寄信人收到了回复。

在这个过程中，原始的收件人永远不会知道原始发送人的地址，他们互相之间只能知道匿名者的地址。

## 为什么要这么做？

NAT在网络中无处不在，在每一个IPv4局域网上几乎无处不在，不过，为什么要有这样一个机制？

使用这种服务，主要有两个原因:
1. 你不想给外部暴露出自己的网络细节。

2. 你需要更多的IP地址，因为别人可分配给你的IP地址已经不够，或者你没有资金去购买更多的IP地址了。

### 隐藏你的网络

通过使用运行NAT的网关将随机的、未经请求的数据包发送到专用网络上不是一件容易的事情。

> 你可以通过一种叫做 _源地址路由_ 的技术，不过它通常不会被ISP启用。

你必须在数据包上包含私有IP地址，**并且**还能将该数据包发送到路由器。除非你的设备和路由器在同一个局域网，不然没有办法做到这一点，而这这种情况几乎不可能。因为上面的第二点，我们需要了解一种被称为 _地址空间耗尽_ 的现象。

### IPv4地址耗尽

世界上IPv4地址的数量是有限的。因此，获得大量的IPv4地址需要花费很多钱。如果先只获得少数地址(例如 `/20` 或`/24`或 `/4`子网)，然后通过NAT再转换出后面大量私有网络花费要小的多。通过这种方式，你可以拥有许多IP，但它们都以来自单个公共IP的形式呈现给外部的互联网世界。

这就是NAT技术解决的最实际的问题。曾经有一段时间，当我们真的要用完IPv4地址时，NAT技术拯救了我们。

## 私有网络

有些子网是保留作为私有网络使用的，路由器不会直接转发这些地址。如果大互联网上的路由器看到来自这些子网之一的IP，将会直接丢弃它。

对于IPv4，这些私有网络地址有如下几个子网段:

* `10.0.0.0/8`
* `172.16.0.0/12`
* `192.168.0.0/16`

最后一种在家庭局域网中非常常见。同样，因特网上的路由器会直接丢弃带有上述地址的数据包。数据从这些ip进入互联网的唯一途径是通过NAT。

## 它如何运作

在后面的演示中，我们将使用`IP:port`表示法。冒号后的数字为端口号。此外，我们将使用术语“本地计算机”来指代局域网上的计算机，而使用“远程计算机”或“远程服务器”来指代它所连接的远程计算机。

最后，本地局域网中的路由器将被称为“路由器”或“NAT路由器”。让我们开始吧！

在我的局域网上，我想从我的私有网段`192.168.1.2:1234`发送数据到公网地址 `203.0.113.24:80`--这里是一个`80`端口，意味着这是一个HTTP服务器。

我的计算机做第一件事就是检查目的地IP地址是否位于我的局域网上。。。而我的局域网是位于`192.168.0.0/16`子网中，很明显，目的地地址不在此子网中。于是，我的电脑会把数据包发送给默认网关，那里有我的带有NAT功能的路由器。

在前面的类比示例中，路由器将扮演“匿名者”中间人的角色。回想一下，路由器上有两个接口——一个面向内部的`192.168.0.0/16`私有局域网，另一个面向更大的互联网，拥有一个公共的外部IP。让我们使用`192.168.1.1`作为路由器上的私有IP地址，`198.51.100.99`作为公网IP。

所以一个局域网看起来会像如下这样:

``` {.default}
+----------+-------------+
|  Local   |             |
| Computer | 192.168.1.2 |>-------+
+----------+-------------+        |
                                  |
                                  ^
                          +---------------+
                          |  192.168.1.1  |  Internal IP
                          +---------------+
                          |    Router     |  NAT-enabled
                          +---------------+
                          | 198.51.100.99 |  External IP
                          +---------------+
                                  v
                                  |
                                  |
                       {The Greater Internet}
```

路由器现在必须为更大的互联网“重新打包”数据。这意味着它需要将数据包中的源地址改写为来自路由器的公网IP和路由器公网接口上一些未被使用的端口。(端口不需要与数据包上最初的端口相同。路由器在发送新数据包时随机分配一个未使用的端口。)

所以路由器会记录如下所有信息:

<!--图示： NAT 路由器连接记录-->
|计算机|IP|端口|协议|
|-|-|-|-|
|本地私有地址|192.168.1.2|1234|TCP|
|远端公网地址|203.0.113.24|80|TCP|
|路由器公网地址|198.51.100.99|5678|TCP|

(注意: 除了`80`端口，因为我们在这个例子中是连接到HTTP，但是所有的端口都是随机被选择的。)

所以当原始数据包是如下所示时:

``` {.default}
192.168.1.2:1234 --> 203.0.113.24:80

     Local               Remote
    Computer            Computer
```

NAT路由器保持目的地地址不变，但使用路由器作为源地址。

``` {.default}
198.51.100.99:5678 --> 203.0.113.24:80

    NAT router             Remote
                          Computer
```

从目的地的角度来看，它完全不知道该数据包是不是来自路由器本身，所以目的地会回复一些HTTP数据，将其发送会相应的路由器:

``` {.default}
203.0.113.24:80 --> 198.51.100.99:5678

    Remote              NAT router
   Computer
```

接着，路由器会查看它的记录，上面写着，“稍等--如果我在端口`5678`收到数据，这意味着我需要将其转换回局域网上的私有IP地址！”因此，它会转换消息，使其不再是路由器的地址，而是发送到之前记录的私有源IP:

``` {.default}
203.0.113.24:80 --> 192.168.1.2:1234

    Remote               Local
   Computer             Computer
```

然后该数据就会发送会局域网，收到了!局域网计算机认为它在与远程服务器通信，而远程服务器认为它在与路由器通信!这就是NAT的作用!

在最后一步中可能会有点混乱，数据包来自NAT路由器，但是它的实际地址却像是来自远程的一个计算机。这在局域网上是可行的，因为NAT路由器发送的IP数据包带有局域网上本地计算机的以太网地址。或者，换句话说，NAT路由器可以使用链路层寻址将数据包发送到本地计算机，而数据包来自的IP地址不必与NAT路由器的因特网IP相匹配。

## NAT和IPv6

因为IPv6拥有 _很多_ 的地址，所以我们在IPv6中还需要NAT么？技术上的答案是“不需要”。IPv6出现的部分原因是为了摆脱这种讨厌的NAT中间人功能。也就是说，在IPv6子网中，有一个为私有网络保留的网段:

``` {.default}
fd00::/8
```

在这种子网中，地址的“host”部分有一些额外的结构，但如果你愿意，你可以在[维基百科上读到](https://en.wikipedia.org/wiki/Unique_local_address#Definition)。像IPv4私有子网一样，这个子网的IP地址会被大互联网上的路由器丢弃。

NAT对IPv6不起作用，但有另一种方法可以用[网络前缀转换](https://en.wikipedia.org/wiki/IPv6-to-IPv6_Network_Prefix_Translation)进行转换。但是，人们不能轻易地将未经请求的数据包发送到你的局域网，这个想法又如何呢?好吧，其实你只需要正确地配置你的防火墙来防止人们进入。但那是另一种方法了。

## 端口转发

如果在NAT路由器后面运行一个服务器程序，它如何向外部世界提供相应的服务呢？毕竟，没有公网上的设备可以通过内网地址联系到他--他们只能知道路由器的公网IP地址。但是你可以配置NAT路由器来做一些叫做 _端口转发_ 的事情。

例如，你可以告诉它，发送到其公共IP端口80的流量应该转发到端口80上的某个私有IP。然后路由器会按照这个规则转发流量，而原始发送方并不知道它的流量最终到达一个私有的IP。在这里，不需要一定要使用相同的端口。

例如，SSH使用22号端口，这在私有网络上的计算机上是没问题的。但是如果你从公网端口22转发，你会发现很多恶意行为者不断试图通过它登录。(是的，即使是在家里的电脑上也会发生。)因此，更常见的做法是使用其他一些不常见的端口作为公共SSH端口，然后将其转发到局域网上的22号端口上。

## 思考题

* 查看下你的计算机的内网IP地址。（你可能需要搜索下资料如何搜到它。）然后打开[google.com](https://google.com/)，并且输入“我的ip地址是什么？”，你看到的数字将大不相同，为什么？

* NAT是为了解决什么问题？