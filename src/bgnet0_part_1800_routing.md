# IP 路由

本章所有的内容都和如何在IP层路由有关，该任务由一种被称之为 _路由器_ 的特殊计算机来完成，该设备知道怎么能正确的将流量转发到与其相连的各个线路。我们将看到，连接到互联网的每台计算机都可以被视作位一台路由器，但它们都依赖于其他路由器将数据包送到目的地。

我们将要讨论如下的两个内容:
* **路由协议簇**: 路由器是如何学习整个网络的“地图”的。

* **路由算法**: 路由器在知道了整个网络地图之后，如何正确的将数据包转换到正确的目的地。

让我们开始学习吧！

## 路由协议簇

路由协议的作用简单来说就是:为路由器提供足够的信息来做出如何路由的决定。换句话说就是，当路由器在一个接口上接收到数据包时，它是如何决定将其转发到哪个接口?它又是如何知道哪条路由通向数据包的最终目的地?

### 内部网关协议簇

当谈到在因特网上路由数据包时，我们需要在更高的维度上来观察这一过程。让我们把互联网看作是一堆松散连接的分块。声明一下，“分块”并不是一个官方的行术语。官方术语是自治系统(autonomous system, AS)，维基百科将其定义为:

> [...] 在一个或多个网络运营商的控制下，代表一个单一的管理实体或域的连接的互联网协议(IP)
> 路由前缀的集合，它向互联网提供一个通用的和明确定义的路由策略。

不过，现在我们就把它们简单的视为一个“分块”。

例如，OSU有一个簇状网络。它有自己的内部路由器和子网，这些路由器和子网“在互联网上”。一家[FAANG公司](https://en.wikipedia.org/wiki/Big Tech#FAANG)可能会有另一块自己的簇状网络。在这些分块的因特网集群中，_内部网关协议_ 用于路由。这是一种路由算法，针对具有少量子网的较小网络进行了优化。

下面是一些内部网关协议的例子

<!-- 图示: 内部网关协议 -->
|缩写|名称|说明|
|-|-|-|
|OSPF|开放式最短路径优先|最常使用, IP层|
|IS-IS|中间系统路由交换协议|链路层|
|EIGRP|增强内部网关路由选择协议|思科拥有一些专利权|
|RIP|路由信息协议|旧协议, 很少被使用|

当然，大家最终需要能够在这些互联网“分块”之间进行通信——毕竟整个互联网是连接的。如果你不能在俄勒冈州使用谷歌的服务器，那将是一件令人沮丧的事情。但很明显，谷歌的服务器没有俄勒冈州立大学的网络地图……那么他们是怎么知道如何进行流量的路由呢?

### 外部网关协议簇

让每个路由器都有一个完整的互联网地图是不切实际的。对于上一节所假设的“分块”模式下获取全局地图是可行的，但是如果想获得全局的地图肯定是不现实的。所以，我们在这里需要处理的是如何在这些“分块”间通信，而 _外部网关协议_ 就是用于在分块间进行通信。

还记得”分块“的官方术语么？自治系统，互联网上的每个自治系统都被分配了一个 _自治系统号(ASN)_，_边界网关协议(BGP)_ 使用ASN号来帮助确定数据包的路由路线。

<!-- 图示: 外部网关协议 --> 

|缩写|名称|说明|
|-|-|-|
|BGP|边界网关协议|广泛被使用|
|EGP|外部网关协议|已经被淘汰|
|Abbreviation|Name|Notes|

BGP有两种模式: 内部BGP和外部BGP。内部模式像内部网关协议一样运作，而外部模式是作为外部网关协议来运行。这个[fl[视频|https://www.youtube.com/watch?v=A1KXPpqlNZ4]]对此有完美的说明，我强烈建议你花两分钟时间看一下这个视频，这样可以融会贯通。

## 路由表

路由表是一种定义了如何转发数据包使得它们可以一路到达远方目的地的配置表。或者说，如果路由器位于目的地局域网中的话，路由表会指导路由器从物理层上（比如说，以太网）将流量从本机发出。上面介绍过的路由协议的一个目标就是帮助因特网上的路由器建立起它们的路由表。

所有连接到互联网的计算机——路由器和其他设备——都有路由表。即使在你的笔记本电脑上，操作系统也必须知道如何处理不同的目标地址。如果目的地是localhost怎么办?如果是同一子网上的另一台计算机又该怎么办?如果是非上面描述的两种情况又该怎么处理?

用一个典型的笔记本电脑作为例子，操作系统会将发送给localhost的流量保持在 _环回地址设备_ 上并且保证一般情况下，这些流量不会被发送到外部的网络中。从程序员的视角来看起来仍然在做网路相关的操作，只不过操作系统知道将到`127.0.0.1`的流量都维持在内部进行路由。

如果你ping到和你在同一局域网的另一台电脑呢?在这种情况下，操作系统首先会检查自己的路由表，确定它在同一个局域网上，并通过以太网将其发送到目的地。

但是，如果你ping到与你完全不同的局域网中的另一台计算机呢?当这种情况发生时，操作系统不能只是发送一个以太网帧并让它到达目的地。因为目的地不在同一个以太网网络上!因此，你的计算机转而将数据包转发到其默认网关，可以看作是最后的路由器。如果在你的计算机中，没有寻找到目标子网的路由表条目，那么操作系统会将其发送到默认网关，后者将其转发到更大的因特网上。

让我用我自己的Linux电脑上的路由表做一个例子，它已经被分配了IP地址`192.168.1.230`。

<!-- 图示: 示例路由表-->
||源地址|目标地址|网关|设备|
|-|-|-|-|-|
|1|`127.0.0.1`|`127.0.0.1`||`lo`|
|2|`127.0.0.1`|`127.0.0.0/8`||`lo`|
|3|`127.0.0.1`|`127.255.255.255`||`lo`|
|4|`192.168.1.230`|`192.168.1.230`||`wlan0`|
|5|`192.168.1.230`|`192.168.1.0/24`||`wlan0`|
|6|`192.168.1.230`|`192.168.1.255`||`wlan0`|
|7|`192.168.1.230`|`default`|`192.168.1.1`|`wlan0`|

首先，让我们来看下从`localhost`到`localhost`(`127.0.0.1`)的路由。在这种情况下，操作系统查找匹配的路由，并在相应的接口上发送数据。此时，匹配到的 _环回地址_ 接口是 (`lo`)，一个操作系统”伪造“的网络接口。（主要是为了性能的原因。）

但是，如果我们从`127.0.0.1`发送数据到子网`127.0.0.0/8`中的任何地址会怎样呢？这种情况下仍然还是使用`lo`接口。并且，如果我们要发送数据到`127.255.255.255`（位于子网 `127.0.0.0/8`上）这样的广播地址也是一样的过程。其他条目就更有趣了。请记住，你查看的路由表机器已经被分配了IP地址`192.168.1.230`。

所以当我们查看上面的第四条时，其实我们正在了解当我从我自己的机器上发送数据给自己的入口。这就像`localhost`，除了我故意使用连接到我的无线局域网设备的IP `wlan0`。操作系统将使用这个条目，但它足够聪明，不会麻烦地通过网络发送——毕竟，这已经就是目的地了。

接下来的一条，是标示从该机器上发送数据给任何位于`192.168.1.0/24` 子网中的主机的路由接口。打个比方来说，从我的机器`192.168.1.230`发送数据给，比如说 `192.168.1.22`，或者任意位于该子网主机。接下来的第六条标示我们有一条位于局域网中的广播地址的路由，它也会通过WiFi设备接口发送出去。

但是，如果上面所有的条目都匹配失败会怎样？比如如果我想从`192.168.1.230`发送到`203.0.113.37`？这个地址不在我路由表中目的地地址的IP或子网中。

这就是第七条的作用: _默认路由_ 。这条是如果不知道如何路由数据，最终路由器发送数据包的地方。在你的家中，路由表中的这条记录一般是由你的网络提供商来填写。或者如果你愿意的话，你也可以自己购买并安装。

所以当从我家里的电脑ping `example.com`（当我写下这些文字的时候，是`93.184.216.34`）时，这些数据包就会从我的默认路由发出，因为其对应的子网并没有出现在我的路由表中。(它们也不会出现在我的默认网关的路由表中。所以,同样的道理，默认网关的路由器也会把它们从它的默认路由转发出去。)

## 路由算法

现在让我们假设路由协议已经完成了它们的工作，并且所有的路由器都拥有它们需要的信息，也就是知道如何一路将数据包转发到指定的目的地。数据包到达时，路由器会按照特定步骤来决定下一步做什么。（在接下来的讨论中，我们将忽略环回设备，并假设所有流量都在实际网络上。）

![IP 路由算法](ip-routing.pdf)

* 如果目的IP直接位于连接到路由器的本地网络中
  * 直接将数据包发送到该链接上（物理层，比如说，以太网）
* 否则，如果在路由表中拥有目的地IP网络的表项
  * 将其转发到通往目的地地址的下一个路由器上
* 否则，如果存在一个默认路由:
  * 将数据包发送给默认路由器
* 如果上述条件皆不满足:
  * 丢掉数据包
  * 发送一个[ICMP](https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol)错误消息“目的地不可达”给发送方。

如果有多条匹配的路由，则选择子网掩码最长的路由。如果掩码长度一样，则选择度量值最少的那个。如果仍然是平局，可以使用ECMP（等代价多路径）路由--将数据包沿两条路由一起发送。

## 路由实例

让我们来看看一个实际的例子 [flx[你可以下载此图表的PDF文件，这样可以获得更清晰的信息|ip-routing-demo.pdf]]。在这张图表中，还有很多缺少的部分。但是值得关注的是，每个路由器接口都附带一个IP地址。

另外一个需要注意的点，比如说，1号路由直接链接到3个子网，并且每个都有对应的一个IP地址。
![网络全览](ip-routing-demo.pdf)

跟踪这些数据包的路由:
<!-- 源和目的地实例 -->
|源|目的地|
|-|-|-|
|`10.1.23.12`|`10.2.1.16`||
|`10.1.99.2`|`10.1.99.6`||
|`192.168.2.30`|`8.8.8.8`||
|`10.2.12.37`|`192.168.2.12`|`10.0.0.0/8` 和 `192.168.0.0/16` 是私有网络，这个接口上的数据并不会被路由到外部的因特网上。|
|`10.1.17.22`|`10.1.17.23`||
|`10.2.12.2`|`10.1.23.12`||

## 路由循环以及存活时间

根据上面的知识，显而易见，我们可以建立起一个循环，让数据包一直在这个循环中传播。为了解决这个问题，IP协议在它的头部有一个字段: _存活时间_ (TTL)。 这是一个从255开始的一个字节表示的计数器，数据包每经历一个路由，其数字都会减一。

当这个计数器减到0的时候，这个数据包会被丢弃并且会给发送端返回一个[ICMP](https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol)”超时“错误消息。所以一个数据包最大只能经过255跳，哪怕在一个无休无止的循环中。

`traceroute`这个程序的工作原理是向TTL为1的目的地发送数据包，并查看谁发送回ICMP消息。然后再发送另一个TTL为2的报文，看看是谁响应了。它不断增加后续数据包的TTL，直到最终目的地响应。

## 广播地址

在IPv4中，有一种特殊的地址叫做 _广播地址_。这是一个将数据包发送给局域网中所有机器的地址。广播地址是一个在子网中将所有主机位都设置为`1`的地址。

举例来说:
<!-- 图示 广播地址 -->
|子网|子网掩码|广播地址|
|-|-|-|
|`10.20.30.0/24`|`255.255.255.0`|`10.20.30.255`|
|`10.20.0.0/16`|`255.255.0.0`|`10.20.255.255`|
|`10.0.0.0/8`|`255.0.0.0`|`10.255.255.255`|

在网络中，还有一个 _唯一_ 的广播地址: `255.255.255.255`。它会将数据发送给局域网上的每一个人。这些广播包不会通过任何路由器，甚至`255.255.255.255`也没有。路由器不会把它们转发到任何地方。不然的话，整个网络世界将会变成一个非常嘈杂的地方。

该地址的一个重要作用是当你第一次打开你的笔记本电脑链接WiFi。笔记本电脑并不知道自己的IP，子网，默认网关，甚至不知道找谁能问到这些信息。所以它会用[DHCP](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol)数据包广播一个数据包到`255.255.255.255` 来询问这些信息。一个DHCP服务器会进行监听并且会回复相应的消息。

既然你们都在疑惑:IPv6没有广播地址;它被一种叫做IPv6多播的东西所消除。同样的道理，只是更加专注于一件事情。

## 思考题

* 内部网关协议和外部网关协议的不同点是什么？

* 一般来说，路由协议的目标是什么？

* 使用内部网关协议的地方的例子是什么?外部网关协议呢?

* 路由器用它的路由表来决定什么?

* 如果目的IP地址不在其本地子网之一上，IP路由器下一步会做什么?

* 一个程序为什么要向广播地址发送一些内容?
